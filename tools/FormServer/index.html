<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Form</title>
    <script>
        window.BASE_PATH = "/tmu/research-2025/onomatopoeia";
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Yu Gothic UI', 'Meiryo UI', sans-serif;
            background-color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4366B0 0%, #2f4373 100%);
            color: #ffffff;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .contact {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .form-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            border-left: 4px solid #4366B0;
            padding-left: 20px;
        }

        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .section-description {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.3;
        }

        .form-item {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9ff;
            border-radius: 15px;
            border: 1px solid rgba(79, 172, 254, 0.1);
        }


        .form-group {
            margin-bottom: 30px;
            padding: 20px;
            background: #f0f4ff;
            border-radius: 15px;
            border: 2px solid rgba(67, 102, 176, 0.2);
        }

        .group-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #4366B0;
            margin-bottom: 15px;
        }

        .group-description {
            color: #666;
            margin-bottom: 20px;
        }

        .group-item {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid rgba(79, 172, 254, 0.1);
        }

        .item-label {
            font-size: 1.1rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .required {
            color: #ff4757;
            margin-left: 5px;
        }

        .item-description {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .slider-container {
            width: 100%;
            max-width: 450px;
            margin: 20px auto;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: #666;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
            background: linear-gradient(to right, #ddd 0%, #4facfe 100%);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4facfe;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4facfe;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .slider-label-min {
            width: auto;
            min-width: 0;
            text-align: left;
            white-space: nowrap;
            position: relative;
            top: 2px;
            margin-left: -50px;
        }
        
        .slider-label-max {
            width: auto;
            min-width: 0;
            text-align: right;
            white-space: nowrap;
            position: relative;
            top: 2px;
            margin-right: -70px;
        }

        .text-input, .number-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .text-input:focus, .number-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .radio-group, .checkbox-group {
            margin-top: 10px;
        }

        .radio-item, .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 2px;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.3s ease;
            cursor: pointer;
        }

        .radio-item:hover, .checkbox-item:hover {
            background: rgba(79, 172, 254, 0.05);
        }

        .radio-item input, .checkbox-item input {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            accent-color: #4facfe;
            cursor: pointer;
        }

        .radio-item label, .checkbox-item label {
            cursor: pointer;
            font-size: 1rem;
        }

        .checkbox-constraints {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 10px;
            font-style: italic;
        }

        .submit-container {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e1e8ed;
        }

        .submit-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .error-message {
            color: #ff4757;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .success-message {
            background: #2ed573;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="survey-title">Survey Form</h1>
            <p id="survey-description">Please fill out this form</p>
            <div class="contact" id="survey-contact"></div>
        </div>
        
        <div class="form-content">
            <div class="success-message" id="success-message">
                アンケートの送信が完了しました。ありがとうございました！
            </div>
            
            <div class="loading" id="loading">
                送信中...
            </div>
            
            <form id="survey-form">
                <div id="form-sections"></div>
                
                <div class="submit-container">
                    <button type="submit" class="submit-btn">送信する</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let surveyData = null;

        // Load survey configuration
        async function loadSurveyConfig() {
            try {
                const basePath = window.BASE_PATH || '';

                let configUrl = `${basePath}/survey_config`;
                let configName = 'default';
                
                console.log("window.BASE_PATH", window.BASE_PATH)
                console.log("basePath", basePath)
                console.log("configUrl", configUrl)
                // Check if a specific config name is set
                if (window.SURVEY_CONFIG_NAME) {
                    configUrl = `${basePath}/api/config/${window.SURVEY_CONFIG_NAME}`;
                    configName = window.SURVEY_CONFIG_NAME;
                }
                
                const response = await fetch(configUrl);
                surveyData = await response.json();
                surveyData.configName = configName; // Store config name for submission
                console.log('Survey data loaded:', surveyData);
                renderSurvey();
            } catch (error) {
                console.error('Error loading survey config:', error);
                alert('アンケートの設定を読み込めませんでした。');
            }
        }

        // Render survey based on JSON configuration
        function renderSurvey() {
            if (!surveyData) return;

            // Set header information
            document.getElementById('survey-title').innerHTML = (surveyData.title || 'Survey Form').replace(/\n/g, '<br>');
            document.getElementById('survey-description').innerHTML = (surveyData.description || '').replace(/\n/g, '<br>');
            document.getElementById('survey-contact').innerHTML = (surveyData.contact || '').replace(/\n/g, '<br>');

            // Render sections
            const sectionsContainer = document.getElementById('form-sections');
            sectionsContainer.innerHTML = '';

            if (surveyData.contents && surveyData.contents.length > 0) {
                surveyData.contents.forEach((section, sectionIndex) => {
                    const sectionElement = createSection(section, sectionIndex);
                    sectionsContainer.appendChild(sectionElement);
                });
            }
        }

        // Create section element
        function createSection(section, sectionIndex) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section';
            
            let sectionHTML = '';
            if (section.title) {
                sectionHTML += `<h2 class="section-title">${section.title.replace(/\n/g, '<br>')}</h2>`;
            }
            if (section.description) {
                sectionHTML += `<p class="section-description">${section.description}</p>`;
            }

            if (section.contents && section.contents.length > 0) {
                section.contents.forEach((item, itemIndex) => {
                    sectionHTML += createFormItem(item, `${sectionIndex}-${itemIndex}`);
                });
            }

            sectionDiv.innerHTML = sectionHTML;
            return sectionDiv;
        }

        // Create form item based on type
        function createFormItem(item, itemId) {
            const required = item.required ? '<span class="required">*</span>' : '';

            if (item.type === "group") {
                // グループ設問の場合
                let html = `<div class="form-group">`;
                html += `<div class="group-title">${item.item}${required}</div>`;
                if (item.description) {
                    html += `<div class="group-description">${item.description}</div>`;
                }
                // グループ内の設問を順番に描画
                item.contents.forEach((subItem, idx) => {
                    html += `<div class="group-item">`;
                    html += createFormItem(subItem, `${itemId}-g${idx}`);
                    html += `</div>`;
                });
                html += `</div>`;
                return html;
            }

            let itemHTML = `
                <div class="form-item">
                    <label class="item-label">${item.item}${required}</label>
            `;

            if (item.description) {
                itemHTML += `<div class="item-description">${item.description}</div>`;
            }

            switch (item.type) {
                case 'slider':
                    itemHTML += createSlider(item, itemId);
                    break;
                case 'text':
                    itemHTML += createTextInput(item, itemId);
                    break;
                case 'number':
                    itemHTML += createNumberInput(item, itemId);
                    break;
                case 'selection':
                    itemHTML += createRadioGroup(item, itemId);
                    break;
                case 'checkbox':
                    itemHTML += createCheckboxGroup(item, itemId);
                    break;
            }

            itemHTML += `<div class="error-message" id="error-${itemId}"></div></div>`;
            return itemHTML;
        }

        // Create slider
        function createSlider(item, itemId) {
            const content = item.content || {};
            const minValue = content['min-value'] || 0;
            const maxValue = content['max-value'] || 100;
            const step = (maxValue - minValue) / 1000;
            const initialValue = (Number(minValue) + Number(maxValue)) / 2;
            
            return `
                <div class="slider-container">
                    <div class="slider-labels">
                        <span class="slider-label-min">${content['min-title'] || 'Min'}</span>
                        <span class="slider-label-max">${content['max-title'] || 'Max'}</span>
                    </div>
                    <input type="range" class="slider" id="${itemId}" name="${itemId}" 
                        min="${minValue}" max="${maxValue}" step="${step}" value="${initialValue}">
                </div>
            `;
        }

        // Create text input
        function createTextInput(item, itemId) {
            const placeholder = item.content?.placeholder || '';
            return `<input type="text" class="text-input" id="${itemId}" name="${itemId}" placeholder="${placeholder}">`;
        }

        // Create number input
        function createNumberInput(item, itemId) {
            const placeholder = item.content?.placeholder || '';
            return `<input type="number" class="number-input" id="${itemId}" name="${itemId}" placeholder="${placeholder}">`;
        }

        // Create radio group
        function createRadioGroup(item, itemId) {
            if (!item.content?.options) return '';
            
            let html = '<div class="radio-group">';
            item.content.options.forEach((option, index) => {
                const optionId = `${itemId}-${index}`;
                html += `
                    <div class="radio-item">
                        <input type="radio" id="${optionId}" name="${itemId}" value="${option.value}">
                        <label for="${optionId}">${option.item}</label>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        // Create checkbox group
        function createCheckboxGroup(item, itemId) {
            if (!item.content?.options) return '';

            const minCheck = item.content['min-check'] || 0;
            const maxCheck = item.content['max-check'] || item.content.options.length;

            let html = `<div class="checkbox-constraints"></div>`;

            const hasRegion = item.content.options.some(option => option.region);

            if (hasRegion) {
                const regions = {};
                item.content.options.forEach(option => {
                    const region = option.region || 'その他';
                    if (!regions[region]) regions[region] = [];
                    regions[region].push(option);
                });

                const regionOrder = [
                    "北海道", "東北", "関東", "中部", "近畿", "中国", "四国", "九州", "沖縄", "その他・海外", "その他"
                ];

                html += '<div class="checkbox-group">';
                regionOrder.forEach(region => {
                    if (regions[region]) {
                        html += `<div style="margin: 10px 0 2px; font-weight: bold;">${region}</div>`;
                        html += '<div style="display: flex; flex-wrap: wrap; gap: 5px 10px; margin-bottom: 5px;">';
                        regions[region].forEach((option, index) => {
                            const optionId = `${itemId}-${region}-${index}`;
                            html += `
                                <div class="checkbox-item" style="min-width: 90px;">
                                    <input type="checkbox" id="${optionId}" name="${itemId}" value="${option.value}"
                                        onchange="validateCheckboxGroup('${itemId}', ${minCheck}, ${maxCheck})">
                                    <label for="${optionId}">${option.item}</label>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                });
                html += '</div>';
            } else {
                html += '<div class="checkbox-group">';
                item.content.options.forEach((option, index) => {
                    const optionId = `${itemId}-${index}`;
                    html += `
                        <div class="checkbox-item" style="min-width: 90px;">
                            <input type="checkbox" id="${optionId}" name="${itemId}" value="${option.value}"
                                onchange="validateCheckboxGroup('${itemId}', ${minCheck}, ${maxCheck})">
                            <label for="${optionId}">${option.item}</label>
                        </div>
                    `;
                });
                html += '</div>';
            }
            return html;
        }

        // Validate checkbox group
        function validateCheckboxGroup(itemId, minCheck, maxCheck) {
            const checkboxes = document.querySelectorAll(`input[name="${itemId}"]:checked`);
            const count = checkboxes.length;
            
            if (count > maxCheck) {
                checkboxes[checkboxes.length - 1].checked = false;
                alert(`最大${maxCheck}個まで選択可能です。`);
            }
        }

        // Form submission
        document.getElementById('survey-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Form submission started');
            
            if (!validateForm()) {
                console.log('Form validation failed');
                return;
            }

            const formData = collectFormData();
            // Add config name to form data
            formData.configName = surveyData.configName || 'default';
            console.log('Form data collected:', formData);
            
            document.getElementById('loading').style.display = 'block';
            
            try {
        const basePath = window.BASE_PATH || '';
                const response = await fetch(`${basePath}/submit_survey`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    document.getElementById('success-message').style.display = 'block';
                    document.getElementById('survey-form').style.display = 'none';
                    console.log('Form submitted successfully');
                } else {
                    throw new Error(`Submission failed with status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                alert('送信エラーが発生しました。もう一度お試しください。');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });

        // Form validation - 修正版
        function validateForm() {
            let isValid = true;
            let firstErrorElement = null;
            console.log('Starting form validation');
            
            if (!surveyData?.contents) return true;

            function validateSection(contents, prefix = '', currentSectionIndex = 0) {
                contents.forEach((item, itemIndex) => {
                    const itemId = prefix ? `${prefix}-g${itemIndex}` : `${currentSectionIndex}-${itemIndex}`;
                    
                    if (item.type === 'group') {
                        // グループ内の要素を再帰的にチェック
                        validateSection(item.contents, itemId, currentSectionIndex);
                        return;
                    }
                    
                    const errorElement = document.getElementById(`error-${itemId}`);
                    if (errorElement) {
                        errorElement.style.display = 'none';
                        errorElement.textContent = '';
                    }

                    let hasError = false;

                    if (item.required) {
                        const isItemValid = validateItem(item, itemId);
                        if (!isItemValid) {
                            isValid = false;
                            hasError = true;
                            if (errorElement) {
                                errorElement.textContent = 'この項目は必須です。';
                                errorElement.style.display = 'block';
                            }
                            console.log(`Validation failed for item: ${itemId}`);
                        }
                    }

                    if (item.type === 'checkbox' && item.content) {
                        const checkboxes = document.querySelectorAll(`input[name="${itemId}"]:checked`);
                        const count = checkboxes.length;
                        const minCheck = item.content['min-check'] || 0;
                        
                        if (count < minCheck) {
                            isValid = false;
                            hasError = true;
                            if (errorElement) {
                                errorElement.textContent = `最低${minCheck}個選択してください。`;
                                errorElement.style.display = 'block';
                            }
                        }
                    }

                    // 最初のエラー要素を記録
                    if (hasError && !firstErrorElement) {
                        const targetElement = document.getElementById(itemId) || errorElement;
                        if (targetElement) {
                            firstErrorElement = targetElement;
                        }
                    }
                });
            }

            surveyData.contents.forEach((section, sectionIndex) => {
                if (!section.contents) return;
                validateSection(section.contents, '', sectionIndex);
            });

            // エラーがある場合、最初のエラー要素までスクロール
            if (!isValid && firstErrorElement) {
                // エラー要素を含む最も近い .form-item または .group-item を探す
                let scrollTarget = firstErrorElement.closest('.form-item') || 
                                 firstErrorElement.closest('.group-item') || 
                                 firstErrorElement;
                
                scrollTarget.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
                
                // 少し遅延してからフォーカスを設定
                setTimeout(() => {
                    if (firstErrorElement.focus) {
                        firstErrorElement.focus();
                    }
                }, 500);
            }

            console.log('Form validation result:', isValid);
            return isValid;
        }

        // Validate individual item
        function validateItem(item, itemId) {
            const element = document.getElementById(itemId);
            if (!element) {
                console.log(`Element not found: ${itemId}`);
                return true;
            }

            switch (item.type) {
                case 'text':
                case 'number':
                    return element.value.trim() !== '';
                case 'selection':
                    return document.querySelector(`input[name="${itemId}"]:checked`) !== null;
                case 'checkbox':
                    const minCheck = item.content?.['min-check'] || 1;
                    return document.querySelectorAll(`input[name="${itemId}"]:checked`).length >= minCheck;
                case 'slider':
                    return true;
                default:
                    return true;
            }
        }

        // Collect form data - 修正版
        function collectFormData() {
            const formData = {
                timestamp: new Date().toISOString(),
                responses: {}
            };

            if (!surveyData?.contents) return formData;

            function collectFromSection(contents, sectionTitle, prefix = '', currentSectionIndex = 0) {
                contents.forEach((item, itemIndex) => {
                    const itemId = prefix ? `${prefix}-g${itemIndex}` : `${currentSectionIndex}-${itemIndex}`;
                    
                    if (item.type === 'group') {
                        // グループ内の要素を再帰的に収集
                        collectFromSection(item.contents, sectionTitle, itemId, currentSectionIndex);
                        return;
                    }
                    
                    const key = `${sectionTitle}_${item.item}`;
                    
                    switch (item.type) {
                        case 'text':
                        case 'number':
                        case 'slider':
                            const element = document.getElementById(itemId);
                            formData.responses[key] = element ? element.value : '';
                            break;
                        case 'selection':
                            const selectedRadio = document.querySelector(`input[name="${itemId}"]:checked`);
                            formData.responses[key] = selectedRadio ? selectedRadio.value : '';
                            break;
                        case 'checkbox':
                            const selectedCheckboxes = document.querySelectorAll(`input[name="${itemId}"]:checked`);
                            formData.responses[key] = Array.from(selectedCheckboxes).map(cb => cb.value);
                            break;
                    }
                });
            }

            surveyData.contents.forEach((section, sectionIndex) => {
                if (!section.contents) return;
                const sectionTitle = section.title || 'Section';
                collectFromSection(section.contents, sectionTitle, '', sectionIndex);
            });

            return formData;
        }

        // Load survey configuration on page load
        window.addEventListener('DOMContentLoaded', loadSurveyConfig);
    </script>
</body>
</html>
